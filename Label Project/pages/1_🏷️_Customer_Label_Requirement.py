# pages/1_üè∑Ô∏è_Customer_Label_Requirement.py

import base64
import streamlit as st
import pandas as pd
from services import labels_v2 as labels_svc
from services import printer as printer_svc
from services import form_builder as form_builder_svc
import qrcode
from io import BytesIO
import html
import textwrap
from datetime import datetime
import time
from utils.auth import AuthManager
from utils.s3_utils import S3Manager
import logging

logger = logging.getLogger(__name__)

# Authentication check
auth_manager = AuthManager()
if not auth_manager.require_auth():
    st.stop()

# Initialize S3
try:
    s3_manager = S3Manager()
except Exception as e:
    st.error("Unable to connect to file storage service. Please contact support.")
    logger.error(f"S3 initialization failed: {e}")
    st.stop()

try:
    import win32print
except ImportError:
    win32print = None

st.set_page_config(layout="wide")
st.title("üè∑Ô∏è Customer Label Requirement Management")

CURRENT_USER_ID = st.session_state.get("user_id", 1)

# KH·ªûI T·∫†O STATE V√Ä MODAL

def init_state():
    # State cho tab Label Fields
    st.session_state.setdefault("lf_current_lt_id", None)
    st.session_state.setdefault("lf_current_lt_name", None)
    st.session_state.setdefault("lf_loaded_lt_id", None)
    st.session_state.setdefault("lf_db_fields", [])
    st.session_state.setdefault("lf_new_fields_buffer", [])

    # State cho lu·ªìng t·∫°o v√† xem tr∆∞·ªõc Label
    st.session_state.setdefault("lf_active_tab", "üìÑ Label Requirement List")
    st.session_state.setdefault("preview_label_data", None) # L∆∞u d·ªØ li·ªáu label ƒë·ªÉ preview v√† quay l·∫°i edit

    # L∆∞u Label Type ƒëang ƒë∆∞·ª£c ch·ªçn ·ªü tab Create Label
    st.session_state.setdefault("cl_selected_lt_label", "(Choose)")

init_state()

def load_fields_from_db_once(requirement_id: int, force: bool = False):
    """T·∫£i danh s√°ch c√°c field t·ª´ DB cho m·ªôt requirement_id c·ª• th·ªÉ."""
    if not force and st.session_state.get("lf_loaded_lt_id") == requirement_id:
        return
    rows = labels_svc.get_label_content_fields(requirement_id)
    st.session_state["lf_db_fields"] = rows # L∆∞u to√†n b·ªô dict t·ª´ DB
    st.session_state["lf_loaded_lt_id"] = requirement_id

# Ch·ªçn Customer
customers = labels_svc.get_active_customers()
if not customers:
    st.warning("No active customer yet")
    st.stop()

customer_label = st.selectbox(
    "üë• *Choose Customer",
    ["(Choose)"] + [f"ID: {p['customer_id']} - {p['customer_english_name']} ({p['customer_code']})" for p in customers],
    key="lf_customer_select"
)

if customer_label == "(Choose)":
    customer_id = None
else:
    customer_id = next(p["customer_id"] for p in customers
                       if f"ID: {p['customer_id']} - {p['customer_english_name']} ({p['customer_code']})" == customer_label)

st.divider()

tab_options = [
    "üìÑ Label Requirement List",
    "‚ûï Create Label Requirement",
    "‚ûï Create Label Fields"
]

def switch_tab():
    st.session_state.lf_active_tab = st.session_state.main_navigation

st.radio(
    " ",
    tab_options,
    index=tab_options.index(st.session_state.get("lf_active_tab", "üìÑ Label Requirement List")),
    horizontal=True,
    key="main_navigation",
    on_change=switch_tab
)

st.divider()

lf_active_tab = st.session_state.lf_active_tab

if lf_active_tab == "üìÑ Label Requirement List":
    if customer_id is None:
        st.warning("‚ö†Ô∏è Please select a **Customer**")
    else:
        # L·∫•y t√™n customer ƒë√£ ch·ªçn ƒë·ªÉ hi·ªÉn th·ªã ti√™u ƒë·ªÅ
        selected_customer_name = customer_label.split(' - ')[1].split(' (')[0]
        st.subheader(f"List of label requirements of: **{selected_customer_name}**")

        # G·ªçi service ƒë·ªÉ l·∫•y danh s√°ch c√°c y√™u c·∫ßu v·ªÅ nh√£n
        requirements = labels_svc.get_customer_label_requirements(customer_id)
        
        if not requirements:
            st.info("This customer has not yet requested any labels to be created")
        else:
            # Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang DataFrame c·ªßa Pandas ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng
            df = pd.DataFrame(requirements)
            
            # T√πy ch·ªânh c√°c c·ªôt c·∫ßn hi·ªÉn th·ªã v√† ƒë·ªïi t√™n ƒë·ªÉ th√¢n thi·ªán h∆°n
            columns_to_display = {
                'customer_code': 'Customer Code',
                'customer_name': 'Customer',
                'requirement_name': 'Requirement Name',
                'requirement_type': 'Requirement Type',
                'label_size': 'Label Size',
                'printer_dpi': 'Printer DPI',
                'printer_type': 'Printer Type',
                'special_notes': 'Special Notes',
                'status': 'Status',
                'effective_from': 'Effective From',
                'created_by': 'Created By'
            }
            
            # L·ªçc ra nh·ªØng c·ªôt c√≥ trong dictionary m√† c≈©ng t·ªìn t·∫°i trong DataFrame
            existing_columns = [col for col in columns_to_display.keys() if col in df.columns]

            # L·ªçc dataframe ƒë·ªÉ ch·ªâ gi·ªØ l·∫°i c√°c c·ªôt c·∫ßn thi·∫øt v√† ƒë√£ t·ªìn t·∫°i
            display_df = df[existing_columns]
            
            # ƒê·ªïi t√™n c·ªôt
            display_df = display_df.rename(columns=columns_to_display)

            # Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu v·ªõi st.dataframe
            st.dataframe(display_df, width='stretch')


elif lf_active_tab == "‚ûï Create Label Requirement":
    if customer_id is None:
        st.warning("‚ö†Ô∏è Please select a **Customer**")
        st.stop()
    
    selected_customer_name = customer_label.split(' - ')[1].split(' (')[0]
    st.subheader(f"Create New Label Requirement for: **{selected_customer_name}**")
    
    # --- PH·∫¶N 1: FORM NH·∫¨P LI·ªÜU (Lu√¥n hi·ªÉn th·ªã) ---
    # S·ª≠ d·ª•ng clear_on_submit=False ƒë·ªÉ gi·ªØ l·∫°i d·ªØ li·ªáu khi ng∆∞·ªùi d√πng quay l·∫°i t·ª´ m√†n h√¨nh review
    with st.form("form_create_label_requirement", clear_on_submit=False):
        c1, c2 = st.columns(2)
        with c1:
            req_name = st.text_input("Requirement Name *")
            req_type = st.selectbox(
                "Requirement Type *",
                options=['ITEM_LABEL', 'CARTON_LABEL']
            )
            # label_size = st.text_input("Label Size")
            ls_c1, ls_c2 = st.columns(2)
            with ls_c1:
                label_width = st.number_input("Label Width *", min_value=1, step=1, value=100)
            with ls_c2:
                label_height = st.number_input("Label Height *", min_value=1, step=1, value=80)
            printer_type = st.text_input("Printer Type")
            
        with c2:
            effective_from = st.date_input("Effective From *", value=datetime.today())
            effective_to = st.date_input("Effective To", value=None)
            printer_dpi = st.number_input("Printer DPI", min_value=0, step=10, value=300)
            status = st.selectbox(
                "Status *",
                options=['DRAFT', 'ACTIVE'],
                index=1
            )

        special_notes = st.text_area("Special Notes")
        
        submitted_review_req = st.form_submit_button("‚û°Ô∏è Review Requirement", type="primary")

    if submitted_review_req:
        label_size = f"{label_width}x{label_height}mm"
        # --- Validate d·ªØ li·ªáu ---
        if not req_name.strip():
            st.error("Requirement Name is required")
        elif not effective_from:
            st.error("Effective From is required")
        elif not label_width:
            st.error("Label Width is required")
        elif not label_height:
            st.error("Label Height is required")
        else:
            # --- L·∫•y th√¥ng tin customer ƒë·ªÉ chu·∫©n b·ªã cho review ---
            selected_customer_info = next((p for p in customers if p['customer_id'] == customer_id), None)
            
            # --- Thay v√¨ l∆∞u v√†o DB, l∆∞u v√†o session_state ƒë·ªÉ review ---
            data_for_review = {
                "customer_id": customer_id,
                "requirement_name": req_name,
                "requirement_type": req_type,
                "effective_from": effective_from,
                "created_by": str(CURRENT_USER_ID),
                "status": status,
                "label_size": label_size.strip() or None,
                "printer_type": printer_type.strip() or None,
                "printer_dpi": printer_dpi if printer_dpi > 0 else None,
                "effective_to": effective_to,
                "special_notes": special_notes.strip() or None,
            }
            st.session_state.clr_review_data = data_for_review
            st.rerun()

    # --- PH·∫¶N 2: KH·ªêI REVIEW (Ch·ªâ hi·ªÉn th·ªã khi c√≥ d·ªØ li·ªáu trong state) ---
    if st.session_state.get("clr_review_data"):
        st.markdown("---")
        st.subheader("Please Review Your Requirement")
        
        review_data = st.session_state.clr_review_data
        
        # Hi·ªÉn th·ªã d·ªØ li·ªáu d∆∞·ªõi d·∫°ng b·∫£ng cho d·ªÖ nh√¨n
        display_data = {
            "Field": list(review_data.keys()),
            "Value": [str(v) if v is not None else "---" for v in review_data.values()]
        }
        st.table(pd.DataFrame(display_data))

        st.markdown("---")
        
        col1, col2, col3 = st.columns([1, 1, 3])
        
        with col1:
            if st.button("‚¨ÖÔ∏è Edit"):
                # X√≥a state review ƒë·ªÉ ·∫©n kh·ªëi n√†y v√† quay l·∫°i ch·ªânh s·ª≠a form
                st.session_state.clr_review_data = None
                st.rerun()
        
        with col2:
            if st.button("‚úÖ Confirm", type="primary"):
                # --- G·ªçi service ƒë·ªÉ l∆∞u v√†o DB ---
                ok, msg, new_req_id = labels_svc.create_customer_label_requirement(review_data)
                
                if ok:
                    st.toast(f"Label request created successfully! New ID: {new_req_id}", icon="‚úÖ")
                    st.balloons()                  
                    # X√≥a state review ƒë·ªÉ ·∫©n kh·ªëi n√†y v√† s·∫µn s√†ng cho l·∫ßn t·∫°o m·ªõi
                    st.session_state.clr_review_data = None
                    st.rerun()
                else:
                    st.error(f"Error: {msg}")

    # --- PH·∫¶N 3: DANH S√ÅCH Y√äU C·∫¶U ƒê√É T·ªíN T·∫†I (Lu√¥n hi·ªÉn th·ªã ·ªü cu·ªëi) ---
    st.markdown("---")
    st.markdown("#### This customer's existing label requirements")
    try:
        existing_requirements = labels_svc.get_customer_label_requirements(customer_id)
        if existing_requirements:
            df = pd.DataFrame(existing_requirements)
            st.dataframe(df[['customer_code', 'customer_name', 'requirement_name', 'requirement_type', 'label_size', 'special_notes', 'status', 'effective_from']])
        else:
            st.info("This customer has no label requests yet")
    except Exception as e:
        st.warning(f"Could not load list of existing requests. Error: {e}")


elif lf_active_tab == "‚ûï Create Label Fields":
    if customer_id is None:
        st.warning("‚ö†Ô∏è Please select a **Customer**")
        st.stop()

    st.subheader("Configure Label Content Fields")
    
    # --- 1. Ch·ªçn Label Requirement ---
    requirements = labels_svc.get_customer_label_requirements(customer_id)
    if not requirements:
        st.info("This customer has no Label Requirements. Please create one in the '‚ûï Create Label Requirement' tab first.")
        st.stop()
    
    req_options = {f"ID: {r['id']} - {r['requirement_type']} ({r['requirement_name']})": r['id'] for r in requirements}
    
    selected_req_label = st.selectbox(
        "Choose a Label Requirement to configure",
        options=["(Choose)"] + list(req_options.keys()),
        key="lf_requirement_selector"
    )

    if selected_req_label == "(Choose)":
        st.session_state["lf_current_lt_id"] = None
        st.session_state["lf_current_lt_name"] = None
        st.info("Select a Label Requirement to see and add fields.")
        st.stop()
    
    requirement_id = req_options.get(selected_req_label)
    if st.session_state.get("lf_current_lt_id") != requirement_id:
        st.session_state["lf_current_lt_id"] = requirement_id
        st.session_state["lf_current_lt_name"] = selected_req_label.split(" (ID:")[0]
        st.session_state["lf_loaded_lt_id"] = None # Force reload
        st.session_state.setdefault("lf_review_buffer", [])
        st.session_state["lf_review_buffer"] = [] # X√≥a buffer khi ƒë·ªïi requirement
        st.rerun()

    load_fields_from_db_once(requirement_id)
    
    st.markdown("---")
    st.subheader(f"Fields for: **{st.session_state.lf_current_lt_name}**")

    # --- 2. Hi·ªÉn th·ªã c√°c field ƒë√£ c√≥ ---
    with st.expander("üìÑ Fields already in the database", expanded=True):
        current_fields_in_db = st.session_state.get("lf_db_fields", [])
        if current_fields_in_db:
            df_db = pd.DataFrame(current_fields_in_db)
            display_cols = ['field_code', 'field_name', 'field_type', 'data_source', 'format_pattern', 'sample_value', 'display_order', 'is_required', 'special_rules']
            existing_display_cols = [col for col in display_cols if col in df_db.columns]
            st.dataframe(df_db[existing_display_cols], hide_index=True, width='stretch')
        else:
            st.info("This Label Requirement has no fields defined yet.")

    # --- 3. Form th√™m field m·ªõi v√†o danh s√°ch review ---
    st.markdown("### Add a New Field")
    with st.form("form_add_field_to_review", clear_on_submit=True):
        c1, c2, c3 = st.columns(3)
        with c1: field_code = st.text_input("Field Code *")
        with c2: field_name = st.text_input("Field Name *")
        with c3:
            VALID_FIELD_TYPES = ['TEXT', 'BARCODE_1D', 'BARCODE_2D', 'QRCODE', 'DATE', 'NUMBER', 'IMAGE']
            field_type = st.selectbox("Field Type *", options=VALID_FIELD_TYPES)

        c4, c5, c6 = st.columns([2, 2, 1])
        with c4: sample_value = st.text_input("Sample Value")
        with c5: format_pattern = st.text_input("Format Pattern")
        with c6: display_order = st.number_input("Display Order", min_value=1, step=1, value=len(current_fields_in_db) + len(st.session_state.get("lf_review_buffer", [])) + 1)
        
        c7, c8 = st.columns([3, 1])
        with c7: data_source = st.text_input("Data Source")
        with c8: is_required = st.checkbox("Is Required?", value=True)

        special_rules = st.text_area("Special Rules")

        submitted_add_to_review = st.form_submit_button("‚ûï Add to Review List")

    if submitted_add_to_review:
        code = field_code.upper().strip()
        name = field_name.strip()
        
        is_in_db = any(f.get("field_code") == code for f in current_fields_in_db)
        is_in_buffer = any(f.get("field_code") == code for f in st.session_state.get("lf_review_buffer", []))

        if not code or not name:
            st.warning("Field Code and Field Name are required.")
        elif is_in_db:
            st.error(f"Error: Field Code '{code}' already exists in the database.")
        elif is_in_buffer:
            st.error(f"Error: Field Code '{code}' is already in the review list.")
        else:
            new_field_data = {
                "field_code": code, "field_name": name, "field_type": field_type,
                "data_source": data_source.strip() or None,
                "format_pattern": format_pattern.strip() or None,
                "sample_value": sample_value.strip() or None,
                "display_order": display_order, "is_required": is_required,
                "special_rules": special_rules.strip() or None
            }
            st.session_state.setdefault("lf_review_buffer", [])
            st.session_state.lf_review_buffer.append(new_field_data)
            st.success(f"Field '{name}' was added to the review list below.")
            st.rerun()

    # --- 4. Hi·ªÉn th·ªã danh s√°ch review v√† n√∫t x√°c nh·∫≠n ---
    review_buffer = st.session_state.get("lf_review_buffer", [])
    if review_buffer:
        st.markdown("---")
        st.subheader("üëÅÔ∏è Fields Pending Review")
        st.caption("These fields have NOT been saved yet. Review them and click 'Confirm & Save All'.")

        df_review = pd.DataFrame(review_buffer)
        st.dataframe(df_review, hide_index=True, width='stretch')
        
        col1, col2, col_spacer = st.columns([2, 2, 5])
        with col1:
            if st.button("‚úÖ Confirm & Save All", type="primary"):
                with st.spinner("Saving fields to database..."):
                    success_count = 0
                    error_messages = []
                    for field_data in review_buffer:
                        # Th√™m requirement_id v√†o d·ªØ li·ªáu tr∆∞·ªõc khi l∆∞u
                        field_data_to_save = field_data.copy()
                        field_data_to_save['requirement_id'] = requirement_id

                        success, message, _ = labels_svc.add_label_content_field(field_data_to_save)
                        if success:
                            success_count += 1
                        else:
                            error_messages.append(f"- Field '{field_data['field_code']}': {message}")
                
                if error_messages:
                    st.error("Some fields could not be saved:")
                    st.markdown("\n".join(error_messages))

                if success_count > 0:
                    st.success(f"‚úÖ Successfully saved {success_count} field(s)!")
                    st.balloons()
                
                # X√≥a buffer v√† t·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
                st.session_state.lf_review_buffer = []
                st.session_state.lf_loaded_lt_id = None
                time.sleep(1)
                st.rerun()

        with col2:
            if st.button("üóëÔ∏è Clear Review List"):
                st.session_state.lf_review_buffer = []
                st.toast("Review list cleared.")
                st.rerun()